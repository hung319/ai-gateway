<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Gateway Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0; --primary: #2563eb; --primary-hover: #1d4ed8;
            --danger: #ef4444; --success: #10b981; --code-bg: #f1f5f9;
        }
        html.dark {
            --bg-body: #020617; --bg-card: #1e293b; --text-main: #f8fafc; --text-sub: #94a3b8;
            --border: #334155; --primary: #3b82f6; --primary-hover: #60a5fa; --code-bg: #0f172a;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; min-height: 100vh; font-size: 15px; }
        * { box-sizing: border-box; }
        .hidden { display: none !important; }

        /* Container */
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }

        /* Login Overlay */
        #loginOverlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--bg-card); width: 100%; max-width: 380px; padding: 40px; border-radius: 16px; border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

        /* Components */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .card { background: var(--bg-card); border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); }
        .card h3 { margin-top: 0; margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        /* Form */
        input, select { width: 100%; padding: 12px; background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; outline: none; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 5px; }
        
        /* Buttons */
        .btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; border: none; transition: 0.2s; }
        .btn-primary { background: var(--primary); } .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); }
        .btn-icon { background: none; border: none; font-size: 1.2rem; color: var(--text-main); cursor: pointer; padding: 5px; }
        .btn-sm { padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; border: 1px solid var(--danger); color: var(--danger); background: transparent; cursor: pointer; }
        .btn-sm:hover { background: var(--danger); color: white; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; }
        .tab-btn { background: none; border: none; padding: 10px 20px; color: var(--text-sub); font-weight: 600; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* List */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); }
        .key-box { font-family: monospace; background: var(--code-bg); padding: 5px 10px; border-radius: 4px; border: 1px dashed var(--border); cursor: pointer; color: var(--primary); user-select: none; }
        .key-box:hover { background: var(--border); }
        .usage-badge { background: var(--bg-body); padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; border: 1px solid var(--border); }

        /* Toast */
        #toast { visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px 24px; position: fixed; z-index: 10000; bottom: 30px; left: 50%; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2 style="margin-top:0; color:var(--primary)"><i class="fa-solid fa-shield-halved"></i> Admin Access</h2>
            <p style="color:var(--text-sub)">Hệ thống bảo mật bằng HttpOnly Cookie</p>
            <form id="loginForm" style="margin-top:20px">
                <input type="password" id="mk" placeholder="Nhập Master Key..." style="text-align:center" required>
                <button class="btn btn-primary">Đăng Nhập</button>
            </form>
            <p id="loginErr" style="color:var(--danger); display:none; margin-top:10px"></p>
        </div>
    </div>

    <div id="app" class="container hidden">
        <header class="header">
            <h1><i class="fa-solid fa-layer-group"></i> AI Gateway</h1>
            <div>
                <button class="icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
                <button class="icon-btn" onclick="logout()" style="color:var(--danger)"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="tab('config')" id="t-config">Cấu Hình</button>
            <button class="tab-btn" onclick="tab('stats')" id="t-stats">Thống Kê</button>
        </div>

        <div id="v-config">
            <div class="card" style="max-width:800px; margin:0 auto 20px auto; border-top:4px solid var(--primary)">
                <h3><i class="fa-solid fa-server"></i> Provider</h3>
                <form id="pForm">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                        <input type="text" id="p_name" placeholder="Alias (vd: gpt)" required>
                        <select id="p_type" onchange="fillUrl()">
                            <option value="openai">OpenAI Standard</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="azure">Azure OpenAI</option>
                        </select>
                    </div>
                    <input type="text" id="p_base" placeholder="Base URL">
                    <input type="password" id="p_key" placeholder="API Key" required>
                    <button class="btn btn-primary">Lưu Provider</button>
                </form>
                <div id="pList" style="margin-top:20px; border-top:1px solid var(--border)"></div>
            </div>

            <div class="card" style="max-width:800px; margin:0 auto; border-top:4px solid var(--success)">
                <h3><i class="fa-solid fa-key"></i> Client Key</h3>
                <form id="kForm" style="display:flex; gap:10px">
                    <input type="text" id="k_name" placeholder="Tên App" required style="margin-bottom:0">
                    <input type="text" id="k_cust" placeholder="Custom Key (Opt)" style="margin-bottom:0">
                    <button class="btn btn-success" style="width:auto">Tạo</button>
                </form>
            </div>
        </div>

        <div id="v-stats" class="hidden">
            <div class="card">
                <h3>Danh Sách Key</h3>
                <div style="display:flex; padding:10px; background:var(--bg-body); font-weight:bold; color:var(--text-sub); font-size:0.8rem; border-radius:6px;">
                    <div style="width:30%">Tên</div>
                    <div style="width:45%">Key (Click copy)</div>
                    <div style="width:15%; text-align:center">Usage</div>
                    <div style="width:10%; text-align:right">Act</div>
                </div>
                <div id="kList"></div>
            </div>
        </div>
    </div>

    <div id="toast">Copied!</div>

    <script>
        // --- THEME ---
        if(localStorage.getItem('theme')==='dark') document.documentElement.classList.add('dark');
        function toggleTheme(){ document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light'); }

        // --- UTILS ---
        function fillUrl() {
            const t = document.getElementById('p_type').value;
            const b = document.getElementById('p_base');
            if(t==='openrouter') { b.value='https://openrouter.ai/api/v1'; b.disabled=false; }
            else if(t==='gemini') { b.value='Native API'; b.disabled=true; }
            else { b.value=''; b.disabled=false; b.placeholder='Base URL'; }
        }

        function tab(name) {
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('v-config').classList.add('hidden');
            document.getElementById('v-stats').classList.add('hidden');
            document.getElementById(`t-${name}`).classList.add('active');
            document.getElementById(`v-${name}`).classList.remove('hidden');
            if(name==='config') loadP();
            if(name==='stats') loadK();
        }

        function showToast(msg) {
            const t = document.getElementById("toast"); t.innerText=msg; t.className="show";
            setTimeout(()=>t.className=t.className.replace("show",""), 2000);
        }

        // Copy Fallback cho HTTP
        function copyText(txt) {
            const ta = document.createElement('textarea');
            ta.value = txt; document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast('Đã copy Key!'); } catch(e){}
            document.body.removeChild(ta);
        }

        // --- API (Automatic Cookie Handling) ---
        async function api(url, method='GET', body=null) {
            try {
                const res = await fetch(url, {
                    method, headers: {'Content-Type':'application/json'},
                    body: body ? JSON.stringify(body) : null
                });
                if(res.status === 401) { 
                    document.getElementById('loginOverlay').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                    return null; 
                }
                return res.ok ? await res.json() : null;
            } catch { return null; }
        }

        // --- DATA ---
        async function loadP() {
            const d = await api('/api/admin/providers');
            if(d) document.getElementById('pList').innerHTML = d.map(p => `
                <div class="list-item">
                    <div><b>${p.name}</b> <span style="font-size:0.85rem; color:var(--text-sub)">(${p.provider_type})</span></div>
                    <button class="btn-sm" onclick="delP('${p.name}')">Xóa</button>
                </div>`).join('');
        }

        async function loadK() {
            const d = await api('/api/admin/keys');
            if(d) {
                d.sort((a,b) => b.is_hidden - a.is_hidden);
                document.getElementById('kList').innerHTML = d.map(k => {
                    const isMaster = k.is_hidden;
                    const keyHtml = isMaster 
                        ? `<span style="color:#d97706; background:#fffbeb; padding:2px 6px; border-radius:4px;">MASTER (Hidden)</span>`
                        : `<span class="key-box" onclick="copyText('${k.key}')" oncontextmenu="return false;">${k.key} <i class="fa-regular fa-copy"></i></span>`;
                    return `
                    <div class="list-item">
                        <div style="width:30%">${k.name}</div>
                        <div style="width:45%">${keyHtml}</div>
                        <div style="width:15%; text-align:center; font-weight:bold; color:${k.usage_count>0?'var(--success)':'var(--text-sub)'}">${k.usage_count}</div>
                        <div style="width:10%; text-align:right">${!isMaster ? `<button class="btn-sm" onclick="delK('${k.key}')">Xóa</button>` : ''}</div>
                    </div>`;
                }).join('');
            }
        }

        // --- AUTH FLOW ---
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const key = document.getElementById('mk').value;
            const res = await fetch('/api/auth/login', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ master_key: key })
            });
            if(res.ok) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadP();
            } else {
                document.getElementById('loginErr').innerText = "Sai Master Key!";
                document.getElementById('loginErr').style.display = 'block';
            }
        };

        async function logout() {
            await fetch('/api/auth/logout', {method:'POST'});
            location.reload();
        }

        async function checkSession() {
            // Gọi thử API, nếu 401 thì api() sẽ tự hiện login form
            const d = await api('/api/admin/providers');
            if(d) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadP();
            }
        }

        // --- HANDLERS ---
        document.getElementById('pForm').onsubmit = async(e)=>{e.preventDefault(); await api('/api/admin/providers','POST',{name:document.getElementById('p_name').value, provider_type:document.getElementById('p_type').value, api_key:document.getElementById('p_key').value, base_url:document.getElementById('p_base').disabled ? null : document.getElementById('p_base').value}); e.target.reset(); loadP(); };
        document.getElementById('kForm').onsubmit = async(e)=>{e.preventDefault(); const r=await api('/api/admin/keys','POST',{name:document.getElementById('k_name').value, custom_key:document.getElementById('k_cust').value||null}); if(r){showToast('Tạo Key OK!');e.target.reset();tab('stats');}};
        async function delP(n){if(confirm('Xóa?')) {await api(`/api/admin/providers/${n}`,'DELETE'); loadP();}}
        async function delK(k){if(confirm('Xóa?')) {await api(`/api/admin/keys/${k}`,'DELETE'); loadK();}}

        // Start
        checkSession();
    </script>
</body>
</html>
