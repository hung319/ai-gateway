<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Gateway Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0; --primary: #3b82f6; --primary-hover: #2563eb;
            --danger: #ef4444; --success: #10b981; --code-bg: #f8fafc;
        }
        html.dark {
            --bg-body: #020617; --bg-card: #1e293b; --text-main: #f8fafc; --text-sub: #94a3b8;
            --border: #334155; --primary: #60a5fa; --primary-hover: #3b82f6; --code-bg: #0f172a;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; min-height: 100vh; transition: 0.3s; font-size: 15px; }
        * { box-sizing: border-box; }
        .hidden { display: none !important; }

        /* LAYOUT RỘNG HƠN */
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* CENTER LOGIN */
        .login-overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--bg-card); width: 400px; padding: 40px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 1px solid var(--border); text-align: center; }

        /* COMPONENTS */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        input, select { width: 100%; padding: 12px; background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; outline: none; }
        input:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; border: none; transition: 0.2s; }
        .btn-primary { background: var(--primary); } .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); }
        
        .tab-btn { background: none; border: none; padding: 10px 20px; color: var(--text-sub); font-weight: 600; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }

        /* KEY DISPLAY & SECURITY */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); }
        
        /* Chống chuột phải vào Key */
        .secure-copy {
            font-family: monospace; background: var(--code-bg); padding: 6px 12px; border-radius: 6px;
            border: 1px dashed var(--border); cursor: pointer; color: var(--primary);
            user-select: none; /* Không cho bôi đen thủ công để ép dùng click */
            -webkit-user-select: none;
        }
        .secure-copy:hover { background: var(--border); }
        .secure-copy:active { transform: scale(0.98); }

        /* Toast */
        #toast { visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 10000; bottom: 30px; left: 50%; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2 style="margin-top:0; color:var(--primary)"><i class="fa-solid fa-shield-cat"></i> Gateway</h2>
            <p style="color:var(--text-sub)">Nhập Master Key để bắt đầu phiên làm việc</p>
            <form id="loginForm">
                <input type="password" id="mk" placeholder="sk-master-..." style="text-align:center" required>
                <button class="btn btn-primary">Đăng Nhập (Secure)</button>
            </form>
            <p id="loginMsg" style="color:var(--danger); font-size:0.9rem; margin-top:10px; display:none"></p>
        </div>
    </div>

    <div id="app" class="container hidden">
        <header class="header">
            <h1 style="margin:0; color:var(--primary)"><i class="fa-solid fa-layer-group"></i> AI Gateway</h1>
            <div>
                <button onclick="toggleTheme()" style="background:none;border:none;font-size:1.2rem;color:var(--text-main);cursor:pointer;margin-right:15px"><i class="fa-solid fa-circle-half-stroke"></i></button>
                <button onclick="logout()" style="background:none;border:none;font-size:1rem;color:var(--danger);cursor:pointer;font-weight:bold">Logout</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('config')" id="t-config">Cấu Hình</button>
            <button class="tab-btn" onclick="switchTab('stats')" id="t-stats">Thống Kê</button>
        </div>

        <div id="v-config">
            <div class="card" style="border-top: 4px solid var(--primary); max-width: 800px; margin: 0 auto 20px auto;">
                <h3><i class="fa-solid fa-server"></i> Thêm Provider</h3>
                <form id="pForm">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="p_name" placeholder="Alias (vd: gpt)" required>
                        <select id="p_type" onchange="handleProviderChange()">
                            <option value="openai">OpenAI Standard</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="azure">Azure OpenAI</option>
                        </select>
                    </div>
                    <input type="text" id="p_base" placeholder="Base URL">
                    <input type="password" id="p_key" placeholder="API Key" required>
                    <button class="btn btn-primary">Lưu Provider</button>
                </form>
                <div id="pList" style="margin-top:20px; border-top:1px solid var(--border)"></div>
            </div>

            <div class="card" style="border-top: 4px solid var(--success); max-width: 800px; margin: 0 auto;">
                <h3><i class="fa-solid fa-key"></i> Tạo Key Client</h3>
                <form id="kForm">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="k_name" placeholder="Tên App (vd: Cursor)" required>
                        <input type="text" id="k_cust" placeholder="Custom Key (Optional)">
                    </div>
                    <button class="btn btn-success">Tạo Key</button>
                </form>
            </div>
        </div>

        <div id="v-stats" class="hidden">
            <div class="card">
                <h3><i class="fa-solid fa-list"></i> Danh sách Key</h3>
                <div style="display:flex; padding:10px; background:var(--bg-body); font-weight:bold; color:var(--text-sub); font-size:0.85rem; border-radius:6px;">
                    <div style="width:30%">Tên</div>
                    <div style="width:40%">Key (Click to copy)</div>
                    <div style="width:20%; text-align:center">Lượt dùng</div>
                    <div style="width:10%; text-align:right">Hành động</div>
                </div>
                <div id="kList"></div>
            </div>
        </div>
    </div>

    <div id="toast">Đã copy vào clipboard!</div>

    <script>
        // --- THEME ---
        if(localStorage.getItem('theme')==='dark') document.documentElement.classList.add('dark');
        function toggleTheme(){ document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light'); }

        // --- LOGIC ---
        function handleProviderChange() {
            const t = document.getElementById('p_type').value;
            const b = document.getElementById('p_base');
            
            if(t === 'gemini') {
                b.value = "Native API (Managed by Gateway)";
                b.disabled = true;
            } else if(t === 'openrouter') {
                b.value = "https://openrouter.ai/api/v1";
                b.disabled = false;
            } else {
                b.value = "";
                b.disabled = false;
                b.placeholder = "Base URL (Optional)";
            }
        }

        // --- API CALL ---
        // Lưu ý: Không gửi Bearer token nữa, trình duyệt tự gửi Cookie
        async function api(url, method='GET', body=null) {
            try {
                const res = await fetch(url, {
                    method, 
                    headers: {'Content-Type': 'application/json'}, 
                    body: body ? JSON.stringify(body) : null
                });
                if(res.status === 401) { logout(); return null; }
                return res.ok ? await res.json() : null;
            } catch { return null; }
        }

        // --- AUTH ---
        async function checkSession() {
            // Gọi thử API lấy list provider để xem cookie còn sống không
            const data = await api('/api/admin/providers');
            if(data) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadProviders();
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
            }
        }

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const key = document.getElementById('mk').value;
            const msg = document.getElementById('loginMsg');
            
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ master_key: key })
                });
                if(res.ok) {
                    checkSession();
                } else {
                    msg.style.display = 'block';
                    msg.innerText = "Key không đúng!";
                }
            } catch {
                msg.style.display = 'block';
                msg.innerText = "Lỗi kết nối server!";
            }
        };

        async function logout() {
            await fetch('/api/auth/logout', {method:'POST'});
            location.reload();
        }

        // --- COPY FUNCTION ---
        function copyKey(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast());
            } else {
                // Fallback cho HTTP
                const ta = document.createElement("textarea");
                ta.value = text; ta.style.position="fixed"; document.body.appendChild(ta);
                ta.focus(); ta.select();
                try { document.execCommand('copy'); showToast(); } catch (e) {}
                document.body.removeChild(ta);
            }
        }
        function showToast() {
            const x = document.getElementById("toast"); x.className = "show";
            setTimeout(() => x.className = x.className.replace("show", ""), 2000);
        }

        // --- DATA ---
        async function loadProviders() {
            const d = await api('/api/admin/providers');
            if(d) document.getElementById('pList').innerHTML = d.map(p => `
                <div class="list-item">
                    <div>
                        <b style="font-size:1.1rem">${p.name}</b> 
                        <span style="background:var(--border);padding:2px 6px;border-radius:4px;font-size:0.8rem;margin-left:10px">${p.provider_type}</span>
                        <div style="font-size:0.85rem;color:var(--text-sub)">${p.base_url || 'Default'}</div>
                    </div>
                    <button onclick="delP('${p.name}')" style="color:var(--danger);background:none;border:none;cursor:pointer;font-size:1.1rem"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function loadKeys() {
            const d = await api('/api/admin/keys');
            if(d) {
                d.sort((a,b) => b.is_hidden - a.is_hidden);
                document.getElementById('kList').innerHTML = d.map(k => {
                    const isMaster = k.is_hidden;
                    // Thêm oncontextmenu="return false" để chặn chuột phải
                    const keyHtml = isMaster 
                        ? `<span style="color:#d97706; background:#fffbeb; padding:4px 8px; border-radius:4px; border:1px dashed #fcd34d">MASTER KEY (Hidden)</span>`
                        : `<span class="secure-copy" onclick="copyKey('${k.key}')" oncontextmenu="return false;" title="Left-click to copy">${k.key} <i class="fa-regular fa-copy"></i></span>`;
                    
                    return `
                    <div class="list-item">
                        <div style="width:30%; font-weight:600">${k.name}</div>
                        <div style="width:40%">${keyHtml}</div>
                        <div style="width:20%; text-align:center; font-weight:bold; color:${k.usage_count>0? 'var(--success)':'var(--text-sub)'}">${k.usage_count}</div>
                        <div style="width:10%; text-align:right">
                            ${!isMaster ? `<button onclick="delK('${k.key}')" style="color:var(--danger);background:none;border:none;cursor:pointer"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(`t-${t}`).classList.add('active');
            document.getElementById('v-config').classList.add('hidden');
            document.getElementById('v-stats').classList.add('hidden');
            document.getElementById(`v-${t}`).classList.remove('hidden');
            if(t==='stats') loadKeys();
        }

        document.getElementById('pForm').onsubmit = async(e)=>{e.preventDefault(); await api('/api/admin/providers','POST',{name:document.getElementById('p_name').value, provider_type:document.getElementById('p_type').value, api_key:document.getElementById('p_key').value, base_url:document.getElementById('p_base').value||null}); e.target.reset(); loadProviders(); };
        document.getElementById('kForm').onsubmit = async(e)=>{e.preventDefault(); const r=await api('/api/admin/keys','POST',{name:document.getElementById('k_name').value, custom_key:document.getElementById('k_cust').value||null}); if(r){alert('Tạo Key thành công!');e.target.reset();switchTab('stats');}};
        async function delP(n){if(confirm('Xóa?')) {await api(`/api/admin/providers/${n}`,'DELETE'); loadProviders();}}
        async function delK(k){if(confirm('Xóa?')) {await api(`/api/admin/keys/${k}`,'DELETE'); loadKeys();}}

        // Init
        checkSession();
    </script>
</body>
</html>
